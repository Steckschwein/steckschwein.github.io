<!doctype html><html lang=en><head><title>IO: VIA 65c22 as SPI-Master :: Steckschwein</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="One of the fundamental design decisions when creating the Steckschwein was to use SPI as the main peripheral bus. This way, various different devices can be utilized using a single interface protocol. The main killer feature for using SPI was to be able to use an SD card as mass storage. This gives us mass storage with almost no extra hardware effort, only level conversion is needed between the system (5V) and the card (3."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://www.steckschwein.de/via-65c22-as-spi-master/><link rel=stylesheet href=https://www.steckschwein.de/assets/style.css><link rel=stylesheet href=https://www.steckschwein.de/assets/green.css><link rel=apple-touch-icon href=https://www.steckschwein.de/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://www.steckschwein.de/img/favicon/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="IO: VIA 65c22 as SPI-Master"><meta property="og:description" content="One of the fundamental design decisions when creating the Steckschwein was to use SPI as the main peripheral bus. This way, various different devices can be utilized using a single interface protocol. The main killer feature for using SPI was to be able to use an SD card as mass storage. This gives us mass storage with almost no extra hardware effort, only level conversion is needed between the system (5V) and the card (3."><meta property="og:url" content="https://www.steckschwein.de/via-65c22-as-spi-master/"><meta property="og:site_name" content="Steckschwein"><meta property="og:image" content="https://www.steckschwein.de/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Steckschwein</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>About</a></li><li><a href=/hardware/>Hardware</a></li><li><a href=/software/>Software</a></li><li><a href=/impressum/>Impressum</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>About</a></li><li><a href=/hardware/>Hardware</a></li><li><a href=/software/>Software</a></li><li><a href=/impressum/>Impressum</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://www.steckschwein.de/via-65c22-as-spi-master/>IO: VIA 65c22 as SPI-Master</a></h1><div class=post-meta></div><div class=post-content><div><p>One of the fundamental design decisions when creating the Steckschwein was to use SPI as the main peripheral bus. This way, various different devices can be utilized using a single interface protocol. The main killer feature for using SPI was to be able to use an SD card as mass storage. This gives us mass storage with almost no extra hardware effort, only level conversion is needed between the system (5V) and the card (3.3V).</p><p>The most common io device for the 6502 processor is the 6522 VIA (Versatile Interface Adapter). In our case, we are using it among a few other things as as the SPI master. VIA port B is solely dedicated to be used with SPI devices. The direction MISO (Master In, Slave Out) is covered by the internal shift register of the VIA. The VIA pins are used as follows:</p><p>|PB0|SPICLK|
|PB1|SS1 SD-card|
|PB2|SS2 PS/2 keyboard controller (ATmega8)|
|PB3|SS3 RTC (DS1306)|
|PB4|SS4 (unused)|
|PB5|sd card write protect|
|PB6|sd card detect|
|PB7|MOSI|
|CB1|SPICLK (connected to PB0)|
|CB2|MISO|</p><p>Basically, the process of reading data via SPI only consists of setting the appropriate slave select pin to low and then &ldquo;wiggling&rdquo; the PB0 pin as fast as possible, which is determined by how fast the CPU is able to write to the port. This also means that the shift register is used in &ldquo;Shift In - External CB1 Clock Control (011)"-mode, which is the very mode affected by the infamous <a href="http://forum.6502.org/viewtopic.php?t=342#p2310">VIA-Bug</a>. We did not do anything circuit wise to implement a workaround. We rather rely on the fact, that we create the SPI clock using the processor and hereby have the SPI clock locked to the system clock, so the signal slopes have a fixed delay. This should take care of the bug not to occur. Hopefully.</p><p><img src=images/io_via.png alt=io_via></p><p><a href=https://steckschwein.files.wordpress.com/2018/03/io.pdf title=io>Schematic as PDF</a></p></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://www.steckschwein.de/assets/main.js></script>
<script src=https://www.steckschwein.de/assets/prism.js></script></div></body></html>