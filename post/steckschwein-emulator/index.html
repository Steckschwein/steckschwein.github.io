<!doctype html><html lang=en><head><title>Steckschwein emulator :: Steckschwein</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Back from the VCFB (Vintage Computer Festival Berlin) 2019 where we had good talks, met interesting people and got new ideas. Especially from Michael Steil who just asked the simple question &amp;ldquo;How you can develop software for the Steckschwein without an emulator?&amp;rdquo;
With the answer in my mind I felt a little annoyed and also &amp;ldquo;triggered&amp;rdquo; at the same time&amp;hellip; However, Michael Steil was nice enough to strip down his Commander X16-Emulator into a barebone 65c02 computer emulator, so all we had to do was to implement our memory map (easy) and borrow a V9958 video chip implementation from blueMSX and implement it into the emulator (hard)."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://beta.steckschwein.de/post/steckschwein-emulator/><link rel=stylesheet href=https://beta.steckschwein.de/assets/style.css><link rel=stylesheet href=https://beta.steckschwein.de/assets/green.css><link rel=apple-touch-icon href=https://beta.steckschwein.de/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://beta.steckschwein.de/img/favicon/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Steckschwein emulator"><meta property="og:description" content="Back from the VCFB (Vintage Computer Festival Berlin) 2019 where we had good talks, met interesting people and got new ideas. Especially from Michael Steil who just asked the simple question &amp;ldquo;How you can develop software for the Steckschwein without an emulator?&amp;rdquo;
With the answer in my mind I felt a little annoyed and also &amp;ldquo;triggered&amp;rdquo; at the same time&amp;hellip; However, Michael Steil was nice enough to strip down his Commander X16-Emulator into a barebone 65c02 computer emulator, so all we had to do was to implement our memory map (easy) and borrow a V9958 video chip implementation from blueMSX and implement it into the emulator (hard)."><meta property="og:url" content="https://beta.steckschwein.de/post/steckschwein-emulator/"><meta property="og:site_name" content="Steckschwein"><meta property="og:image" content="https://beta.steckschwein.de/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="allgemein"><meta property="article:published_time" content="2019-12-09 00:00:00 +0000 UTC"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Steckschwein</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>About</a></li><li><a href=/hardware/>Hardware</a></li><li><a href=/software/>Software</a></li><li><a href=/impressum/>Impressum</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>About</a></li><li><a href=/hardware/>Hardware</a></li><li><a href=/software/>Software</a></li><li><a href=/impressum/>Impressum</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://beta.steckschwein.de/post/steckschwein-emulator/>Steckschwein emulator</a></h1><div class=post-meta><span class=post-date>2019-12-09</span></div><div class=post-content><div><p>Back from the VCFB (Vintage Computer Festival Berlin) 2019 where we had good talks, met interesting people and got new ideas. Especially from <a href=https://www.pagetable.com/>Michael Steil</a> who just asked the simple question <strong>&ldquo;How you can develop software for the Steckschwein without an emulator?&rdquo;</strong></p><p>With the answer in my mind I felt a little annoyed and also &ldquo;triggered&rdquo; at the same time&mldr; However, Michael Steil was nice enough to strip down his Commander X16-Emulator into a barebone 65c02 computer emulator, so all we had to do was to implement our memory map (easy) and borrow a V9958 video chip implementation from blueMSX and implement it into the emulator (hard).</p><p>We&rsquo;ll guide you through the adaption of the emulator step by step. Let&rsquo;s start with the &ldquo;easy&rdquo; part, the&mldr;</p><h3 id=memory-mapping>Memory Mapping<a href=#memory-mapping class=hanchor arialabel=Anchor>&#8983;</a></h3><p>is done in a dedicated file <a href=https://github.com/twoinke/steckschwein-emulator/blob/master/memory.c>memory.c</a> where we simply do the dispatching to a dedicated hardware emulation upon a given address. Luckily the Steckschwein i/o is located in a dedicated and continuous address range within $0200-$0280.</p><p>So if the CPU accesses these address range e.g. asking for a byte from such an address via</p><p><code>LDA $0220</code></p><p>the emulator dispatches the memory read to the corresponding i/o implementation. this  is done with a simple ordered &ldquo;if-cascade&rdquo; as follows</p><pre tabindex=0><code>uint8_t
real_read6502(uint16_t address, bool debugOn, uint8_t bank)
{
	if (address &lt; 0x0200)
	{ // RAM
		return RAM[address];
	}
	else if (address &lt; 0x0280) { // I/O
		// TODO I/O map?
		if (address  &lt; 0x210) // UART at $0200
		{
			return uart_read(address &amp; 0xf);
		}
		else if (address &lt; 0x0220) // VIA at $0210
		{
			return via1_read(address &amp; 0xf);
		}
		else if (address &lt; 0x0230) // VDP at $0220
		{
			return ioPortRead(NULL,address);
		}
</code></pre><p>The LDA shown above will end up in the line with</p><p><code>return ioPortRead(NULL,address);</code></p><p>and thus our VDP implementation is asked for a byte to read.</p><p>All other addresses are either RAM or ROM depending on the value within our memory control port $0230. For more details check out the <a href=http://steckschwein.de/hardware/cpuramdecoder/>memory map</a>.</p><h3 id=via-and-sdcard>VIA and SDCard<a href=#via-and-sdcard class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The X16 and the Steckschwein share a few similar approaches, for example in terms of mass storage and/or peripheral communication. Both use the VIA to implement the SPI bus protocol via &ldquo;bit banging&rdquo; to communicate with various components, such as the SD card or the RTC. This part of the emulator almost completely derived from the X16 emulator, with only small modifications.</p><h3 id=emulating-the-v9958>Emulating the V9958<a href=#emulating-the-v9958 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The video part was much more difficult, because Steckschwein uses the <a href=http://steckschwein.de/hardware/v9958-video-board/>V9958</a>. Emulating that kind of video chip is much much work todo and requires a very good understanding what&rsquo;s really going on within the chip at every µs when the screen is drawn.</p><p>Fortunately the MSX and MSX2 systems are very good documented and there are plenty of emulators with source available. As this sounds good the outcome of our investigation was quite sober. Only the fMSX and the blueMSX emulators gave us an idea how we can use or reuse the code of the VDP implementation.</p><p>Although the <a href=http://www.bluemsx.com/>blueMSX</a> code is not maintained anymore we decided to give&rsquo;em a try. This is because the blueMSX implementation is build more like a kind of emulator framework which can be used to build emulators for a wide range of hardware and not only for MSX systems.</p><p>For short, the following changes where made to get the emulator with the VDP work</p><ol><li>strip out unnecessary code and extract the raw VDP V9558 implementation</li><li>create a blueMSX board implementation for Steckschwein</li><li>adapt the fake6502.c code to the blueMSX API with the appropriate cpu callbacks</li><li>glue code to dispatch the i/o access of addresses $220-$224 to the blueMSX VDP code</li><li>get cyclic exact timings required for video by using the blueMSX timer loop</li></ol><p>And here we are&mldr; the emulator is able to boot our bios, which in turn mounts the sdcard and loads the kernel just like the real Steckschwein does.</p><p><img src=images/steckschwein_emulator_vdp-1.jpg alt=steckschwein_emulator_vdp></p><p>On the screenshot you may have noticed the &ldquo;date&rdquo; tool, which actually gives the correct datetime. Hence the rtc emulation is also done already.</p><p>to be continued&mldr;</p><p>code: <a href=https://github.com/Steckschwein/steckschwein-emulator>https://github.com/Steckschwein/steckschwein-emulator</a></p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://beta.steckschwein.de/post/chuck-peddle-1937-2019/><span class=button__icon>←</span>
<span class=button__text>Chuck Peddle, 1937 - 2019</span></a></span>
<span class="button next"><a href=https://beta.steckschwein.de/post/markos-pacman-talk-at-vcfb/><span class=button__text>Markos Pacman Talk at VCFb</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://beta.steckschwein.de/assets/main.js></script>
<script src=https://beta.steckschwein.de/assets/prism.js></script></div></body></html>