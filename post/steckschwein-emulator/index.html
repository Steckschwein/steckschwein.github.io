<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon.ico><title>Steckschwein emulator - Steckschwein</title><meta name=description content="Back from the VCFB (Vintage Computer Festival Berlin) 2019 where we had good talks, met interesting people and got new ideas. Especially from Michael Steil who just asked the simple question &ldquo;How you can develop software for the Steckschwein without an emulator?&rdquo;
With the answer in my mind I felt a little annoyed and also &ldquo;triggered&rdquo; at the same time&mldr; However, Michael Steil was nice enough to strip down his Commander X16-Emulator into a barebone 65c02 computer emulator, so all we had to do was to implement our memory map (easy) and borrow a V9958 video chip implementation from blueMSX and implement it into the emulator (hard)."><meta name=generator content="Hugo 0.101.0"><link rel=stylesheet href=https://steckschwein.github.io/css/main.css><meta property="og:title" content="Steckschwein emulator"><meta property="og:description" content="Back from the VCFB (Vintage Computer Festival Berlin) 2019 where we had good talks, met interesting people and got new ideas. Especially from Michael Steil who just asked the simple question &ldquo;How you can develop software for the Steckschwein without an emulator?&rdquo;
With the answer in my mind I felt a little annoyed and also &ldquo;triggered&rdquo; at the same time&mldr; However, Michael Steil was nice enough to strip down his Commander X16-Emulator into a barebone 65c02 computer emulator, so all we had to do was to implement our memory map (easy) and borrow a V9958 video chip implementation from blueMSX and implement it into the emulator (hard)."><meta property="og:type" content="article"><meta property="og:url" content="https://steckschwein.github.io/post/steckschwein-emulator/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-12-09T00:00:00+00:00"><meta property="article:modified_time" content="2019-12-09T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Steckschwein emulator"><meta name=twitter:description content="Back from the VCFB (Vintage Computer Festival Berlin) 2019 where we had good talks, met interesting people and got new ideas. Especially from Michael Steil who just asked the simple question &ldquo;How you can develop software for the Steckschwein without an emulator?&rdquo;
With the answer in my mind I felt a little annoyed and also &ldquo;triggered&rdquo; at the same time&mldr; However, Michael Steil was nice enough to strip down his Commander X16-Emulator into a barebone 65c02 computer emulator, so all we had to do was to implement our memory map (easy) and borrow a V9958 video chip implementation from blueMSX and implement it into the emulator (hard)."><meta itemprop=name content="Steckschwein emulator"><meta itemprop=description content="Back from the VCFB (Vintage Computer Festival Berlin) 2019 where we had good talks, met interesting people and got new ideas. Especially from Michael Steil who just asked the simple question &ldquo;How you can develop software for the Steckschwein without an emulator?&rdquo;
With the answer in my mind I felt a little annoyed and also &ldquo;triggered&rdquo; at the same time&mldr; However, Michael Steil was nice enough to strip down his Commander X16-Emulator into a barebone 65c02 computer emulator, so all we had to do was to implement our memory map (easy) and borrow a V9958 video chip implementation from blueMSX and implement it into the emulator (hard)."><meta itemprop=datePublished content="2019-12-09T00:00:00+00:00"><meta itemprop=dateModified content="2019-12-09T00:00:00+00:00"><meta itemprop=wordCount content="674"><meta itemprop=keywords content><meta itemprop=name content="Steckschwein emulator"><meta itemprop=description content="Back from the VCFB (Vintage Computer Festival Berlin) 2019 where we had good talks, met interesting people and got new ideas. Especially from Michael Steil who just asked the simple question &ldquo;How you can develop software for the Steckschwein without an emulator?&rdquo;
With the answer in my mind I felt a little annoyed and also &ldquo;triggered&rdquo; at the same time&mldr; However, Michael Steil was nice enough to strip down his Commander X16-Emulator into a barebone 65c02 computer emulator, so all we had to do was to implement our memory map (easy) and borrow a V9958 video chip implementation from blueMSX and implement it into the emulator (hard)."><meta itemprop=datePublished content="2019-12-09T00:00:00+00:00"><meta itemprop=dateModified content="2019-12-09T00:00:00+00:00"><meta itemprop=wordCount content="674"><meta itemprop=keywords content></head><body class="flex relative h-full min-h-screen"><aside class="will-change-transform transform transition-transform -translate-x-full absolute top-0 left-0 md:relative md:translate-x-0 w-3/4 md:w-60 h-full min-h-screen p-3 bg-slate-50 dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col gap-2.5 z-20 sidebar"><p class="font-bold mb-5 flex items-center gap-2"><button aria-label="Close sidebar" class="md:hidden menu-trigger-close p-1 rounded text-slate-800 dark:text-slate-50 hover:bg-slate-200 dark:hover:bg-slate-700"><svg class="h-6 w-6" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
<a href=https://steckschwein.github.io class=px-2><span>Steckschwein</span></a>
<button aria-label="Toggle dark mode" class="dark-mode-toggle p-2 rounded border dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700"><svg class="h-4 w-4" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7M6.3 17.7l-.7.7"/></svg></button></p><ul class="list-none flex flex-col gap-1"><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between hover:bg-slate-200 dark:hover:bg-slate-700" href=/home/><span>The Project</span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between hover:bg-slate-200 dark:hover:bg-slate-700" href=/hardware/><span>Hardware</span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between hover:bg-slate-200 dark:hover:bg-slate-700" href=/software/><span>Software</span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between hover:bg-slate-200 dark:hover:bg-slate-700" href=/impressum/><span>Impressum</span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between hover:bg-slate-200 dark:hover:bg-slate-700" href=/articles/><span>Articles</span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between hover:bg-slate-200 dark:hover:bg-slate-700" href=/post/><span>Posts</span></a></li></ul><div class=flex-1></div><ul class="list-none flex flex-wrap justify-center gap-1 pt-2 border-t border-slate-200 dark:border-slate-600"></ul></aside><div class="fixed bg-slate-700 bg-opacity-5 transition duration-200 ease-in-out inset-0 z-10 pointer-events-auto md:hidden left-0 top-0 w-full h-full hidden menu-overlay"></div><button aria-label="Toggle Sidebar" class="md:hidden absolute top-3 left-3 z-10 menu-trigger p-1 rounded text-slate-800 dark:text-slate-50 hover:bg-slate-100"><svg class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="18" x2="16" y2="18"/></svg></button><div class=flex-1><main class="h-screen overflow-y-auto"><div class="px-6 py-20 w-full lg:w-[580px] mx-auto prose dark:prose-invert h-fit prose-img:mx-auto"><h1>Steckschwein emulator</h1><p class="text-sm text-slate-500 !mb-8">December 9, 2019</p><p>Back from the VCFB (Vintage Computer Festival Berlin) 2019 where we had good talks, met interesting people and got new ideas. Especially from <a href=https://www.pagetable.com/ target=_blank rel=noopener>Michael Steil</a> who just asked the simple question <strong>&ldquo;How you can develop software for the Steckschwein without an emulator?&rdquo;</strong></p><p>With the answer in my mind I felt a little annoyed and also &ldquo;triggered&rdquo; at the same time&mldr; However, Michael Steil was nice enough to strip down his Commander X16-Emulator into a barebone 65c02 computer emulator, so all we had to do was to implement our memory map (easy) and borrow a V9958 video chip implementation from blueMSX and implement it into the emulator (hard).</p><p>We&rsquo;ll guide you through the adaption of the emulator step by step. Let&rsquo;s start with the &ldquo;easy&rdquo; part, the&mldr;</p><h3 id=memory-mapping>Memory Mapping</h3><p>is done in a dedicated file <a href=https://github.com/twoinke/steckschwein-emulator/blob/master/memory.c target=_blank rel=noopener>memory.c</a> where we simply do the dispatching to a dedicated hardware emulation upon a given address. Luckily the Steckschwein i/o is located in a dedicated and continuous address range within $0200-$0280.</p><p>So if the CPU accesses these address range e.g. asking for a byte from such an address via</p><p>LDA $0220</p><p>the emulator dispatches the memory read to the corresponding i/o implementation. this  is done with a simple ordered &ldquo;if-cascade&rdquo; as follows</p><p>uint8_t
real_read6502(uint16_t address, bool debugOn, uint8_t bank)
{
if (address &lt; 0x0200)
{ // RAM
return RAM[address];
}
else if (address &lt; 0x0280) { // I/O
// TODO I/O map?
if (address &lt; 0x210) // UART at $0200
{
return uart_read(address & 0xf);
}
else if (address &lt; 0x0220) // VIA at $0210
{
return via1_read(address & 0xf);
}
else if (address &lt; 0x0230) // VDP at $0220
{
return ioPortRead(NULL,address);
}</p><p>The LDA shown above will end up in the line with</p><p>return ioPortRead(NULL,address);</p><p>and thus our VDP implementation is asked for a byte to read.</p><p>All other addresses are either RAM or ROM depending on the value within our memory control port $0230. For more details check out the <a href=http://steckschwein.de/hardware/cpuramdecoder/ target=_blank rel=noopener>memory map</a>.</p><h3 id=via-and-sdcard>VIA and SDCard</h3><p>The X16 and the Steckschwein share a few similar approaches, for example in terms of mass storage and/or peripheral communication. Both use the VIA to implement the SPI bus protocol via &ldquo;bit banging&rdquo; to communicate with various components, such as the SD card or the RTC. This part of the emulator almost completely derived from the X16 emulator, with only small modifications.</p><h3 id=emulating-the-v9958>Emulating the V9958</h3><p>The video part was much more difficult, because Steckschwein uses the <a href=http://steckschwein.de/hardware/v9958-video-board/ target=_blank rel=noopener>V9958</a>. Emulating that kind of video chip is much much work todo and requires a very good understanding what&rsquo;s really going on within the chip at every µs when the screen is drawn.</p><p>Fortunately the MSX and MSX2 systems are very good documented and there are plenty of emulators with source available. As this sounds good the outcome of our investigation was quite sober. Only the fMSX and the blueMSX emulators gave us an idea how we can use or reuse the code of the VDP implementation.</p><p>Although the <a href=http://www.bluemsx.com/ target=_blank rel=noopener>blueMSX</a> code is not maintained anymore we decided to give&rsquo;em a try. This is because the blueMSX implementation is build more like a kind of emulator framework which can be used to build emulators for a wide range of hardware and not only for MSX systems.</p><p>For short, the following changes where made to get the emulator with the VDP work</p><ol><li>strip out unnecessary code and extract the raw VDP V9558 implementation</li><li>create a blueMSX board implementation for Steckschwein</li><li>adapt the fake6502.c code to the blueMSX API with the appropriate cpu callbacks</li><li>glue code to dispatch the i/o access of addresses $220-$224 to the blueMSX VDP code</li><li>get cyclic exact timings required for video by using the blueMSX timer loop</li></ol><p>And here we are&mldr; the emulator is able to boot our bios, which in turn mounts the sdcard and loads the kernel just like the real Steckschwein does.</p><p><img src=images/steckschwein_emulator_vdp-1.jpg alt=steckschwein_emulator_vdp></p><p>On the screenshot you may have noticed the &ldquo;date&rdquo; tool, which actually gives the correct datetime. Hence the rtc emulation is also done already.</p><p>to be continued&mldr;</p><p>code: <a href=https://github.com/twoinke/steckschwein-emulator target=_blank rel=noopener>https://github.com/twoinke/steckschwein-emulator</a></p></div></main></div><script type=text/javascript src=/main.js defer></script></body></html>