<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Saving ASCII sources in EhBasic - </title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:url" content="https://www.steckschwein.de/post/ascii_save_ehbasic/"><meta property="og:title" content="Saving ASCII sources in EhBasic"><meta property="og:description" content="Our FAT32 driver now supports byte-wise writing of a file. Reason enough to continue reworking the file handling of our EhBasic port that we started here to finally having the SAVE command write ASCII source files.
The basic idea is to open a file, redirect the EhBasic output vector to our new kernel call “krn_write_byte”, then trigger the LIST command internally. The listing being output by LIST will then be written to the opened file instead the screen."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-12-10T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-10T00:00:00+00:00"><meta property="article:tag" content="Fat"><meta property="article:tag" content="Basic"><meta itemprop=name content="Saving ASCII sources in EhBasic"><meta itemprop=description content="Our FAT32 driver now supports byte-wise writing of a file. Reason enough to continue reworking the file handling of our EhBasic port that we started here to finally having the SAVE command write ASCII source files.
The basic idea is to open a file, redirect the EhBasic output vector to our new kernel call &ldquo;krn_write_byte&rdquo;, then trigger the LIST command internally. The listing being output by LIST will then be written to the opened file instead the screen."><meta itemprop=datePublished content="2023-12-10T00:00:00+00:00"><meta itemprop=dateModified content="2023-12-10T00:00:00+00:00"><meta itemprop=wordCount content="291"><meta itemprop=keywords content="Fat,Basic"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=Steckschwein rel=home><div class="logo__item logo__text"><div class=logo__title>Steckschwein</div><div class=logo__tagline>An 8bit computer for the 21st century</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li><li class=menu__item><a class=menu__link href=/><span class=menu__text>Blog</span></a></li><li class=menu__item><a class=menu__link href=/hardware/><span class=menu__text>Hardware</span></a></li><li class=menu__item><a class=menu__link href=/software/><span class=menu__text>Software</span></a></li><li class=menu__item><a class=menu__link href=/resources/><span class=menu__text>Resources</span></a></li><li class=menu__item><a class=menu__link href=/impressum/><span class=menu__text>Impressum</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Saving ASCII sources in EhBasic</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 110 28 1 1 0 010-28m0 3a3 3 0 100 22 3 3 0 000-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class=meta__text datetime=2023-12-10T00:00:00Z>December 10, 2023</time></div></div></header><div class="content post__content clearfix"><p>Our FAT32 driver now supports byte-wise writing of a file. Reason enough to continue reworking the file handling of our EhBasic port that we started <a href=/post/ascii_ehbasic/>here</a> to finally having the SAVE command write ASCII source files.</p><p>The basic idea is to open a file, redirect the EhBasic output vector to our new kernel call &ldquo;krn_write_byte&rdquo;, then trigger the LIST command internally. The listing being output by LIST will then be written to the opened file instead the screen. Finally, once LIST is done writing, close the file and return.</p><p>So far, so easy, but like the ASCII LOAD, doing the actual implementation was a little more involved than anticipated.</p><p>First of all, after opening the file, the file descriptor number is in X, which we save to a memory location. Before calling &ldquo;krn_write_byte&rdquo;, the file descriptor number must be in X again. This means we can not just set the output vector to &ldquo;krn_write_byte&rdquo;. We need a wrapper routine to get X first:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>fwrite_wrapper:
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>save</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ldx</span> <span style=color:#66d9ef>_fd</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jsr</span> <span style=color:#66d9ef>krn_write_byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>restore</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rts</span> 
</span></span></code></pre></div><p>Now the output vector needs to point to our new routine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>      <span style=color:#a6e22e>lda</span> <span style=color:#75715e>#&lt;fwrite_wrapper
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>sta</span> <span style=color:#66d9ef>VEC_OUT</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lda</span> <span style=color:#75715e>#&gt;fwrite_wrapper
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>sta</span> <span style=color:#66d9ef>VEC_OUT</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>Our kernel calls use the carry flag to signal if the call was successful. A successful fat_open will clear the carry flag. But internally, EhBasic&rsquo;s LIST command uses the carry flag, too. So before calling the internal LIST routine, we just set the carry again because LIST will not output anything if we don&rsquo;t.
Also, we do not jsr to the beginning at LAB_LIST, we use LAB_14BD a bit further down to skip a few parameter checks.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>      <span style=color:#a6e22e>sec</span> <span style=color:#75715e>; set carry to make LIST do anything
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>jsr</span> <span style=color:#66d9ef>LAB_14BD</span> <span style=color:#75715e>; jump into LIST routine
</span></span></span></code></pre></div><p>Finally, our EhBasic LOADs and SAVEs ASCII files.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 000-6 3 3 0 000 6"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/fat/ rel=tag>fat</a></li><li class=tags__item><a class="tags__link btn" href=/tags/basic/ rel=tag>basic</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2024 .
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>