<!doctype html><html lang=en><head><title>Loading ASCII sources in EhBasic :: Steckschwein</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Since our implementation of FAT32 now supports reading a file byte for byte, a little rework of the file handling in our version of EhBasic is in order.
In the past, we only could read or write a file as a whole, relative to the location in memory where the according pointer pointed to. We used this in EhBasic to save and load BASIC programs by dumping and reloading it’s binary representation from memory."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://www.steckschwein.de/post/ascii_ehbasic/><link rel=stylesheet href=https://www.steckschwein.de/assets/style.css><link rel=stylesheet href=https://www.steckschwein.de/assets/green.css><link rel=stylesheet href=https://www.steckschwein.de/style.css><link rel=apple-touch-icon href=https://www.steckschwein.de/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://www.steckschwein.de/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content="@steckschwein"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Loading ASCII sources in EhBasic"><meta property="og:description" content="Since our implementation of FAT32 now supports reading a file byte for byte, a little rework of the file handling in our version of EhBasic is in order.
In the past, we only could read or write a file as a whole, relative to the location in memory where the according pointer pointed to. We used this in EhBasic to save and load BASIC programs by dumping and reloading it’s binary representation from memory."><meta property="og:url" content="https://www.steckschwein.de/post/ascii_ehbasic/"><meta property="og:site_name" content="Steckschwein"><meta property="og:image" content="https://www.steckschwein.de/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-09-23 15:00:00 +0000 UTC"><meta name=google-site-verification content="h4ZvO_kCiqz0Kjn0VkOKXvui3t2_-dYAoAzrCy6mQNM"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Steckschwein</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/>Blog</a></li><li><a href=/about/>About</a></li><li><a href=/hardware/>Hardware</a></li><li><a href=/software/>Software</a></li><li><a href=/impressum/>Impressum</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/>Blog</a></li><li><a href=/about/>About</a></li><li><a href=/hardware/>Hardware</a></li><li><a href=/software/>Software</a></li><li><a href=/impressum/>Impressum</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://www.steckschwein.de/post/ascii_ehbasic/>Loading ASCII sources in EhBasic</a></h1><div class=post-meta><span class=post-date>2021-09-23
[Updated: 2021-09-23]</span></div><div class=post-content><div><p>Since our implementation of FAT32 now supports reading a file byte for byte, a little rework of the file handling in our version of EhBasic is in order.</p><p>In the past, we only could read or write a file as a whole, relative to the location in memory where the according pointer pointed to. We used this in EhBasic to save and load BASIC programs by dumping and reloading it’s binary representation from memory. While this works well, this approach has the major disadvantage that the saved program will be incompatible with other versions of EhBasic or even with our own when the token list is changed, which happens when adding new commands.</p><p>So clearly, the better approach is to read the BASIC program as source in it’s ASCII representation. This is the way EhBasic’s late creator, Lee Davison, preferred, and suggested how to implement this:</p><pre><code>To load an ASCII program redirect the character input vector to read 
from your filesystem and return to the main interpreter loop. 
The input vector should be restored and the file closed when the 
file end is reached or an error is encountered.
</code></pre><p>Basically the interpreter would read characters and interpret them, just like them being typed in, but instead they will be read from the file. So, our LOAD command is implemented like this:</p><pre tabindex=0><code>LAB_LOAD: 
    lda #O_RDONLY 
    jsr openfile

    lda #&lt;fread_wrapper 
    sta VEC_IN 
    lda #&gt;fread_wrapper 
    sta VEC_IN+1

    lda #&lt;outvec_dummy 
    sta VEC_OUT 
    lda #&gt;outvec_dummy 
    sta VEC_OUT+1 

    JMP LAB_1319 ; reset and return
</code></pre><p>All it does is changing the in and output vectors and then returning back to the interpreter, which then begins to read characters from VEC_IN until the file is read. But then what? The input vector still points to fread_wrapper, how do we get control back?
That’s the reason we did not point the vector directly to fat_fread_byte. Instead, we implemented a wrapper, which will read a byte from the file and pass it to EhBasic, and restore the vectors when EOF is reached:</p><pre tabindex=0><code>fread_wrapper: 
    phx 
    phy 
    ldx _fd 
    jsr krn_fread_byte 
    bcs @eof 
    cmp #KEY_LF ; replace with &#34;basic end of line&#34; 
    bne :+ 
    lda #KEY_CR
:   ply   
    plx 
    cmp #0 
    rts
@eof: 
    jsr krn_close
    jsr init_iovectors
    SMB7 OPXMDM ; set upper bit in flag (print Ready msg) 
    jmp LAB_1319 ; cleanup and Return to BASIC

init_iovectors: 
    lda #&lt;krn_chrout 
    sta VEC_OUT 
    lda #&gt;krn_chrout 
    sta VEC_OUT+1
    lda #&lt;krn_getkey 
    sta VEC_IN 
    lda #&gt;krn_getkey 
    sta VEC_IN+1 
    rts
</code></pre><p>Also, outvec dummy ist just an empty subroutine which we set the output vector VEC_OUT to, in order to suppress output while loading. Otherwise, the input would be echoed by the interpreter loop, resulting in the program being listed during load.</p><pre tabindex=0><code>outvec_dummy: 
    rts
</code></pre><p>Now we’re ready to feed almost any BASIC source to EhBasic, which will make porting existing BASIC software pretty easy.</p><p><img src=images/basic_load.png alt="ASCII based LOAD in action" title="ASCII based LOAD in action"></p><p>The next step will be to save BASIC programs in ASCII format by setting VEC_OUT accordingly and triggering a LIST command.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://www.steckschwein.de/post/512k-ought-to-be-enough-for-anybody/><span class=button__icon>←</span>
<span class=button__text>512k Ought to Be Enough for Anybody</span></a></span>
<span class="button next"><a href=https://www.steckschwein.de/post/fixing-ps-2-keyboard-handling-part-i/><span class=button__text>Fixing PS/2 Keyboard handling (Part I)</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://www.steckschwein.de/assets/main.js></script>
<script src=https://www.steckschwein.de/assets/prism.js></script></div></body></html>