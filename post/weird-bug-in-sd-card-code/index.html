<!doctype html><html lang=en><head><title>Weird bug in SD card code :: Steckschwein</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Frank van den Hoef, who is adapting the Steckschwein SPI &amp;amp; FAT32 code for his tiny65 machine made me aware of a classic mistake for a 6502 assembly coder to make. Namely in our sdcard driver, when waiting for the &amp;ldquo;proper&amp;rdquo; response from the card (which should have bit 7 cleared). The routine handling this looked like this:
1 sd_cmd_response_wait: 2 ldy #sd_cmd_response_retries 3 @l:	dey 4 beq sd_block_cmd_timeout ; y already 0?"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://beta.steckschwein.de/post/weird-bug-in-sd-card-code/><link rel=stylesheet href=https://beta.steckschwein.de/assets/style.css><link rel=stylesheet href=https://beta.steckschwein.de/assets/green.css><link rel=apple-touch-icon href=https://beta.steckschwein.de/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://beta.steckschwein.de/img/favicon/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Weird bug in SD card code"><meta property="og:description" content="Frank van den Hoef, who is adapting the Steckschwein SPI &amp;amp; FAT32 code for his tiny65 machine made me aware of a classic mistake for a 6502 assembly coder to make. Namely in our sdcard driver, when waiting for the &amp;ldquo;proper&amp;rdquo; response from the card (which should have bit 7 cleared). The routine handling this looked like this:
1 sd_cmd_response_wait: 2 ldy #sd_cmd_response_retries 3 @l:	dey 4 beq sd_block_cmd_timeout ; y already 0?"><meta property="og:url" content="https://beta.steckschwein.de/post/weird-bug-in-sd-card-code/"><meta property="og:site_name" content="Steckschwein"><meta property="og:image" content="https://beta.steckschwein.de/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="assembly"><meta property="article:section" content="code"><meta property="article:section" content="debugging"><meta property="article:section" content="murphy"><meta property="article:section" content="sd-karte"><meta property="article:section" content="spi"><meta property="article:published_time" content="2019-10-16 00:00:00 +0000 UTC"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Steckschwein</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>About</a></li><li><a href=/hardware/>Hardware</a></li><li><a href=/software/>Software</a></li><li><a href=/impressum/>Impressum</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>About</a></li><li><a href=/hardware/>Hardware</a></li><li><a href=/software/>Software</a></li><li><a href=/impressum/>Impressum</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://beta.steckschwein.de/post/weird-bug-in-sd-card-code/>Weird bug in SD card code</a></h1><div class=post-meta><span class=post-date>2019-10-16</span></div><div class=post-content><div><p>Frank van den Hoef, who is adapting the Steckschwein SPI & FAT32 code for his tiny65 machine made me aware of a classic mistake for a 6502 assembly coder to make. Namely in our sdcard driver, when waiting for the &ldquo;proper&rdquo; response from the card (which should have bit 7 cleared). The routine handling this looked like this:</p><pre tabindex=0><code>1  sd_cmd_response_wait:
2 	ldy #sd_cmd_response_retries
3 @l:	dey
4         beq sd_block_cmd_timeout ; y already 0? then invalid response or timeout
5         jsr spi_r_byte
6         bit #80	; bit 7 clear
7         bne @l  ; no, next byte
8         cmp #$00 ; got cmd response, check if $00 to set z flag accordingly
9         rts
10 sd_block_cmd_timeout:
11        debug &#34;sd_block_cmd_timeout&#34;
12        lda #$1f ; make up error code distinct from possible sd card responses to mark timeout
13        rts
</code></pre><p>Classic. Obviously, line 6 should read:</p><pre tabindex=0><code>          bit #$80 ; bit 7 clear
</code></pre><p>With that fixed, the sd card init routine now fails, which is odd since we fixed something that was obviously broken.</p><p><img src=images/sd_fail-e1571229478149.jpg alt=sd_fail.jpg></p><p>Ok, now what? Enabling Marko&rsquo;s mighty debugging macros, it becomes apparent that the sd card init fails right after sending CMD0 to the card. This command is the first command of the init sequence and is supposed to put the card into &ldquo;idle mode&rdquo;. Which the card confirms with an answer of $01. Which is what the init code is expecting, and not getting. Instead, we get $3F, which does not make a lot of sense.</p><p>But why did it work before the fix? Assuming that the card did not change it&rsquo;s behaviour at the same time I fixed the code, let&rsquo;s check what actually happened. Before the fix, we were ANDing $3F with 80:</p><p><code>00111111 $3f</code><br><code>01010000 80 (no $, decimal)</code></p><p>In this case, the BNE after the BIT #80 would take the branch to @l, causing the next byte being read, until finally the card responds with $01:</p><p><code>00000001 $01</code><br><code>01010000 80 (no $, decimal)</code></p><p>Now the BNE does not take the branch, and the routine exits.</p><p>Now, with the fixed code,  ANDing $3F with **$**80, to check if bit 7 is clear, which it is:</p><p><code>00111111 $3F</code><br><code>10000000 $80</code></p><p>Alright, exit the loop and return $3f as response of the card. Which isn&rsquo;t $01, so init failed.</p><p>At this point, I have no explanation for the card responding $3F. I assume that the card might be not ready to process commands at this point, so I added code to repeat sending CMD0 until we get $01 or we run out of retries.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://beta.steckschwein.de/post/markos-pacman-talk-at-vcfb/><span class=button__icon>←</span>
<span class=button__text>Markos Pacman Talk at VCFb</span></a></span>
<span class="button next"><a href=https://beta.steckschwein.de/post/forth-benchmarks/><span class=button__text>Forth Benchmarks</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://beta.steckschwein.de/assets/main.js></script>
<script src=https://beta.steckschwein.de/assets/prism.js></script></div></body></html>