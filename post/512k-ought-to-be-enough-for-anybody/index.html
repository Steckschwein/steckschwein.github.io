<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>512k Ought to Be Enough for Anybody - Steckschwein</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="512k Ought to Be Enough for Anybody"><meta property="og:description" content="The biggest limitation of any 8 bit CPU such as our beloved 65C02 is the amount of memory that the CPU can address. With 16 address lines, the addressable memory is maxed out at 64k. All ROM and RAM has to be crammed into there. With the 6502 being a memory mapped architecture, IO devices need their addresses there, too.
In order to expand the amount of usable memory, some trickery is necessary."><meta property="og:type" content="article"><meta property="og:url" content="https://www.steckschwein.de/post/512k-ought-to-be-enough-for-anybody/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-05-27T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-27T00:00:00+00:00"><meta itemprop=name content="512k Ought to Be Enough for Anybody"><meta itemprop=description content="The biggest limitation of any 8 bit CPU such as our beloved 65C02 is the amount of memory that the CPU can address. With 16 address lines, the addressable memory is maxed out at 64k. All ROM and RAM has to be crammed into there. With the 6502 being a memory mapped architecture, IO devices need their addresses there, too.
In order to expand the amount of usable memory, some trickery is necessary."><meta itemprop=datePublished content="2022-05-27T00:00:00+00:00"><meta itemprop=dateModified content="2022-05-27T00:00:00+00:00"><meta itemprop=wordCount content="854"><meta itemprop=keywords content="ram,cpld,mmu,"><meta name=twitter:card content="summary"><meta name=twitter:title content="512k Ought to Be Enough for Anybody"><meta name=twitter:description content="The biggest limitation of any 8 bit CPU such as our beloved 65C02 is the amount of memory that the CPU can address. With 16 address lines, the addressable memory is maxed out at 64k. All ROM and RAM has to be crammed into there. With the 6502 being a memory mapped architecture, IO devices need their addresses there, too.
In order to expand the amount of usable memory, some trickery is necessary."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=Steckschwein rel=home><div class="logo__item logo__text"><div class=logo__title>Steckschwein</div><div class=logo__tagline>An 8bit computer for the 21st century</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Blog</span></a></li><li class=menu__item><a class=menu__link href=/hardware/><span class=menu__text>Hardware</span></a></li><li class=menu__item><a class=menu__link href=/software/><span class=menu__text>Software</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li><li class=menu__item><a class=menu__link href=/impressum/><span class=menu__text>Impressum</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>512k Ought to Be Enough for Anybody</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2022-05-27T00:00:00Z>May 27, 2022</time></div></div></header><div class="content post__content clearfix"><p>The biggest limitation of any 8 bit CPU such as our beloved 65C02 is the amount of memory that the CPU can address. With 16 address lines, the addressable memory is maxed out at 64k. All ROM and RAM has to be crammed into there. With the 6502 being a memory mapped architecture, IO devices need their addresses there, too.</p><p>In order to expand the amount of usable memory, some trickery is necessary. For example, the developers of the C64 came up with a rather clever hack to cram 20k of ROM and full 64k of RAM and IO area into 64k address space by introducing a register that enables the programmer to switch off the ROM, giving access to the underlying RAM. When the ROM is enabled, writes to the addresses go into the RAM below.
We decided to mimic this behaviour in our current implementation of the Steckschwein glue logic.</p><p>But it’s time to move on. More sophisticated 8bit machines such as the C128 or the CPC6128 have a more clever banking logic to give the CPU more than 64k to work with. The C128 even has a MMU. The next logical step for the Steckschwein is to have a MMU, too.
We decided to reimplement our glue logic from scratch using a CPLD and expand our memory space in the process.</p><p>We decided to go for 512k RAM. In order to address that much memory, the first thing we need to add are three more address lines. That’s where the CPLD comes in. In order to cut the 512k ram into smaller banks, so we can easier address them, the CPLD does not only provide the address lines A16 – A18, but also doubles the address lines A14-A15. Address lines A0-A15 from the CPU go to the CPLD to be decoded. RAM and ROM only see A0-A13 from the CPU and A14-A18 from the CPLD.
This way we can split the 512k into 32 banks of 16k each. The 64k address space of the Steckschwein is now organized as four “slots” with 16k each.
Four registers in the CPLD, which are mapped into the IO area contain the values for the extra address lines and are used as selectors for which bank is mapped into which slot. Bit 7 will select ROM instead of RAM, so that ROM banks are being handled just like another memory page. Also, this means a departure from our 8k ROM bank size.
We might upgrade the 32k 28C256 EEPROM to a 512k Flash EEPROM in one of the next iterations, giving us 32 RAM and 32 ROM banks. Also, adding another address line is not a big deal, so upgrading to 1MB will be easy.</p><table><thead><tr><th style=text-align:center>Slot</th><th style=text-align:center>Start</th><th style=text-align:center>End</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:center>$0000</td><td style=text-align:center>$3fff</td></tr><tr><td style=text-align:center>1</td><td style=text-align:center>$4000</td><td style=text-align:center>$7fff</td></tr><tr><td style=text-align:center>2</td><td style=text-align:center>$8000</td><td style=text-align:center>$bfff</td></tr><tr><td style=text-align:center>3</td><td style=text-align:center>$c000</td><td style=text-align:center>$ffff</td></tr></tbody></table><p>The 4 Slots within the 64k address space</p><pre tabindex=0><code>+--------+--------+--------+--------+
|Slot 0  |Slot 1  |Slot 2  |Slot3   |
+--------+--------+--------+--------+
|Bank 81*|        |        |        |
+--------+--------+--------+--------+
|Bank 80*|
+--------+--------+--------+--------+
|  ....  |Bank 81 |
+--------+--------+--------+--------+
|Bank 4  |  ...   |        |        |
+--------+--------+--------+--------+
|Bank 3  |Bank 3  |Bank 81*|        |
+--------+--------+--------+--------+
|Bank 1  |Bank 2  |Bank 80*|        |
+--------+--------+--------+--------+
|Bank 0  |Bank 1  |Bank 30 |Bank 81*| &lt;- You are here!
+--------+--------+--------+--------+
|        |Bank 0  |Bank 29 |Bank 80*|
+--------+--------+--------+--------+
|        |        |Bank 28 |Bank 30 |
+--------+--------+--------+--------+
|        |        |Bank 27 |Bank 29 |
+--------+--------+--------+--------+
|        |        |Bank 26 |Bank 28 |
+--------+--------+--------+--------+
|        |        |Bank 25 |Bank 27 |
+--------+--------+--------+--------+
|        |        |  ....  |Bank 26 |
+--------+--------+--------+--------+
|        |        |Bank 0  |Bank 25 |
+--------+--------+--------+--------+
|        |        |        |  ....  |
+--------+--------+--------+--------+
|        |        |        |Bank 0  |
+--------+--------+--------+--------+


*=ROM     
</code></pre><p>The above illustration shows how the Slot selection scheme works. It is also possible to map the same bank into all four slots.</p><p>In order to be able to execute the RESET Vector the CPU requires ROM being present in Slot 3 at system start time. So the default bank assignment looks like this:</p><table><thead><tr><th style=text-align:center>Slot</th><th style=text-align:center>Bank</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:center>0</td></tr><tr><td style=text-align:center>1</td><td style=text-align:center>1</td></tr><tr><td style=text-align:center>2</td><td style=text-align:center>2</td></tr><tr><td style=text-align:center>3</td><td style=text-align:center>80</td></tr></tbody></table><p>We do not need the ROMOFF mechanism anymore, so the loading of steckOS will follow a different procedure:</p><pre><code>System bootup with bank $80 (ROM) in slot 3
Bootloader switches slot 2 to bank 3 (or whatever bank the OS shall be in)
Bootloader writes steckOS to slot 2 ($8000)
Bootloader switches slot 3 to bank 3
Bootloader jumps to steckOS init
</code></pre><p>This memory banking scheme is rather simple, but provides a lot of flexibility in order to use more than 64k of memory. Also, all kinds of memory (ROM, RAM) are being treated the same way, so it’s much cleaner than the ROMOFF approach. Being able to remap the area containing the zero page and stack will also help implementing some sort of task switching or even multitasking.
On the downside, it’s flexible but pretty dumb as the software has to keep track of what has been put in which bank.
We a really eager to explore this idea, so the VHDL code for the XC9572 CPLD has been written, the board has been designed and waiting to be delivered.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/ram/ rel=tag>ram</a></li><li class=tags__item><a class="tags__link btn" href=/tags/cpld/ rel=tag>cpld</a></li><li class=tags__item><a class="tags__link btn" href=/tags/mmu/ rel=tag>mmu</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 Steckschwein.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>